{% extends "app1/base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h3 class="mb-3">Find Veteran Facilities Near You</h3>

  <!-- Shown if GOOGLE_MAPS_API_KEY is missing -->
  <div id="env-warning" class="alert alert-warning d-none"></div>

  <!-- Inputs -->
  <div class="row g-2 mb-3">
    <div class="col-12 col-lg-6">
      <input id="place" class="form-control"
             placeholder='City, State or ZIP (e.g., "Chico, CA" or "95928")'>
    </div>
    <div class="col-6 col-lg-2">
      <input id="lat" class="form-control" placeholder="Latitude (optional)">
    </div>
    <div class="col-6 col-lg-2">
      <input id="lng" class="form-control" placeholder="Longitude (optional)">
    </div>
    <div class="col-12 col-lg-2">
      <select id="radius" class="form-select">
        <option value="10000">10 km</option>
        <option value="20000" selected>20 km</option>
        <option value="50000">50 km</option>
      </select>
    </div>
  </div>

  <!-- Actions -->
  <div class="d-flex gap-2 mb-3">
    <button id="locate" class="btn btn-outline-secondary">Use my location</button>
    <button id="search" class="btn btn-primary">Search Veterans Services</button>
  </div>

  <!-- Messages + Results -->
  <div id="error" class="alert alert-danger d-none"></div>
  <div id="empty" class="text-muted">No results yet.</div>
  <div id="results"></div>
</div>

<!-- Plain JS; no React/CDNs -->
<script>
(function () {
  const $ = s => document.querySelector(s);
  const place = $('#place'), lat = $('#lat'), lng = $('#lng'), radius = $('#radius');
  const btnSearch = $('#search'), btnLocate = $('#locate');
  const results = $('#results'), err = $('#error'), empty = $('#empty'), warn = $('#env-warning');

  function showError(msg){ err.textContent = msg; err.classList.remove('d-none'); }
  function hideError(){ err.classList.add('d-none'); err.textContent = ''; }
  function setEmpty(show, text){ empty.textContent = text || 'No results yet.'; empty.style.display = show ? '' : 'none'; }

  function makeCard(p){
    const name = (p.displayName && p.displayName.text) || 'Unknown';
    const addr = p.formattedAddress || '';
    const phone = p.nationalPhoneNumber || p.internationalPhoneNumber || '';
    const lat = p.location && p.location.latitude;
    const lng = p.location && p.location.longitude;
    const guri = p.googleMapsUri;
    const mapHref = guri || ((lat && lng) ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}` : null);

    const el = document.createElement('div');
    el.className = 'card mb-3';
    el.innerHTML = `
      <div class="card-body">
        <h5 class="card-title mb-1">${name}</h5>
        <div class="small text-muted mb-2">${addr}</div>
        ${phone ? `<div class="mb-2">${phone}</div>` : ``}
        ${mapHref ? `<a class="btn btn-sm btn-outline-primary" target="_blank" href="${mapHref}">Open in Maps</a>` : ``}
      </div>`;
    return el;
  }

  async function runSearch(){
    hideError();
    results.innerHTML = '';
    setEmpty(true, 'Searchingâ€¦');

    const qs = new URLSearchParams();
    if (place.value.trim()) qs.append('place', place.value.trim());
    if (lat.value && lng.value) { qs.append('lat', lat.value.trim()); qs.append('lng', lng.value.trim()); }
    qs.append('radius', radius.value);

    try {
      const r = await fetch(`/api/veterans_nearby?${qs.toString()}`);
      const data = await r.json();

      // Show helpful banner if key missing; keep HTTP 200 for easy demos
      if (data.error) {
        if ((data.error || '').includes('Missing GOOGLE_MAPS_API_KEY')) {
          warn.classList.remove('d-none');
          warn.innerHTML = `
            <strong>Google Places API key not set.</strong>
            Copy <code>.env.example</code> to <code>.env</code> and add:
            <pre class="mt-2 mb-0">GOOGLE_MAPS_API_KEY=YOUR_KEY</pre>
            Then restart: <code>python manage.py runserver</code>.
          `;
        } else {
          showError(`${data.error}${data.details ? ': ' + data.details : ''}`);
        }
      }

      const arr = data.results || [];
      results.innerHTML = '';
      if (arr.length === 0) { setEmpty(true, 'No veteran-focused places found for that area.'); return; }
      setEmpty(false);
      arr.forEach(p => results.appendChild(makeCard(p)));
    } catch (e) {
      showError('Search failed. Check server logs.');
    }
  }

  btnLocate.addEventListener('click', () => {
    hideError();
    if (!navigator.geolocation) { showError('Geolocation not supported'); return; }
    navigator.geolocation.getCurrentPosition(
      pos => {
        lat.value = pos.coords.latitude.toFixed(6);
        lng.value = pos.coords.longitude.toFixed(6);
      },
      e => showError(e.message)
    );
  });

  btnSearch.addEventListener('click', runSearch);
})();
</script>
{% endblock %}
