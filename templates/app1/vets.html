{% extends "app1/base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h3 class="mb-3">Find Veteran Facilities Near You</h3>

  <!-- Added by Web Developer GPT (2025-10-08): placeholder to surface env/API key warnings -->
  <div id="env-warning" class="alert alert-warning d-none"></div>

  <!-- Inputs -->
  <div class="row g-2 mb-3 align-items-end">
    <div class="col-12 col-lg-8">
      <label for="place" class="form-label">City, State or ZIP</label>
      <input id="place" class="form-control"
             placeholder='e.g., "Chico, CA" or "95928"'
             autocomplete="off" inputmode="search">
      <div class="form-text">Or use your current location.</div>
    </div>

    <!-- Added by Web Developer GPT (2025-10-08): switch radius UI to miles -->
    <div class="col-6 col-lg-2">
      <label for="radius" class="form-label">Radius (miles)</label>
      <select id="radius" class="form-select">
        <option value="10">10 mi</option>
        <option value="20" selected>20 mi</option>
        <option value="50">50 mi</option>
      </select>
    </div>

    <!-- Added by Web Developer GPT (2025-10-08): keep lat/lng for programmatic use, hide from UI -->
    <div class="d-none">
      <input id="lat" />
      <input id="lng" />
    </div>
  </div>

  <!-- Actions -->
  <div class="d-flex gap-2 mb-3">
    <button id="locate" class="btn btn-outline-secondary">Use my location</button>
    <button id="search" class="btn btn-primary">Search Veterans Services</button>
  </div>

  <!-- Added by Web Developer GPT (2025-10-08): human-friendly geolocation status text -->
  <div id="geo-status" class="text-muted small mb-2"></div>

  <!-- Messages + Results -->
  <div id="error" class="alert alert-danger d-none"></div>
  <div id="empty" class="text-muted">No results yet.</div>
  <div id="results"></div>
</div>
<script>
(function () {
  // Shortcuts
  const $ = s => document.querySelector(s);

  const place   = $('#place');
  const latI    = $('#lat');
  const lngI    = $('#lng');
  const radius  = $('#radius');
  const btnSearch = $('#search');
  const btnLocate = $('#locate');
  const results = $('#results');
  const err     = $('#error');
  const empty   = $('#empty');
  const warn    = $('#env-warning');
  const geoTxt  = $('#geo-status');
// Functions for UI updates
  function showError(msg){ err.textContent = msg; err.classList.remove('d-none'); }
  function hideError(){ err.classList.add('d-none'); err.textContent = ''; }
  function setEmpty(show, text){ empty.textContent = text || 'No results yet.'; empty.style.display = show ? '' : 'none'; }
  function setGeo(text){ geoTxt.textContent = text || ''; }

  // Added by Web Developer GPT (2025-10-08): miles -> meters conversion for backend compatibility
  const milesToMeters = mi => Math.round(Number(mi || 0) * 1609.344);

  // Added by Web Developer GPT (2025-10-08): show only "City, State" in results
  function cityStateFromAddress(addr) {
    if (!addr) return '';
    const parts = addr.split(',').map(s => s.trim());
    if (parts.length >= 3) {
      const city = parts[parts.length - 3];
      const stateZip = parts[parts.length - 2].split(/\s+/)[0];
      return `${city}, ${stateZip}`;
    }
    return addr;
  }

  // Fixed & enhanced by Web Developer GPT (2025-10-08): corrected template strings and safety
  function makeCard(p){
    const name = (p.displayName && p.displayName.text) || 'Unknown';
    const addr = p.formattedAddress || '';
    const phone = p.nationalPhoneNumber || p.internationalPhoneNumber || '';
    const plat = p.location && p.location.latitude;
    const plng = p.location && p.location.longitude;
    const guri = p.googleMapsUri;
    const mapHref = guri || ((plat != null && plng != null)
                   ? `https://www.google.com/maps/search/?api=1&query=${plat},${plng}`
                   : null);

    const el = document.createElement('div');
    el.className = 'card mb-3';
    el.innerHTML = `
      <div class="card-body">
        <h5 class="card-title mb-1">${name}</h5>
        <div class="small text-muted mb-2">${cityStateFromAddress(addr)}</div>
        ${phone ? `<div class="mb-2">${phone}</div>` : ``}
        ${mapHref ? `<a class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener" href="${mapHref}">Open in Maps</a>` : ``}
      </div>`;
    return el;
  }

  async function runSearch(){
    hideError();
    results.innerHTML = '';
    setEmpty(true, 'Searching…');

    const qs = new URLSearchParams();
    const placeVal = place.value.trim();

    // Added by Web Developer GPT (2025-10-08): prefer typed place; fall back to geolocated lat/lng
    if (placeVal) {
      qs.append('place', placeVal);
    } else if (latI.value && lngI.value) {
      qs.append('lat', latI.value);
      qs.append('lng', lngI.value);
    } else {
      setEmpty(true, 'Enter a city/state or ZIP, or use your location.');
      return;
    }

    // Added by Web Developer GPT (2025-10-08): send meters even though UI is miles
    qs.append('radius', String(milesToMeters(radius.value)));

    try {
      const r = await fetch(`/api/veterans_nearby?${qs.toString()}`);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();

      if (data.error) {
        // Added by Web Developer GPT (2025-10-08): friendlier  warning block
        if ((data.error || '').includes('Missing GOOGLE_MAPS_API_KEY')) {
          warn.classList.remove('d-none');
          warn.innerHTML = `
            <strong>Google Places API key not set.</strong>
            Copy <code>.env.example</code> to <code>.env</code> and add:
            <pre class="mt-2 mb-0">GOOGLE_MAPS_API_KEY=YOUR_KEY</pre>
            Then restart: <code>python manage.py runserver</code>.
          `;
          setEmpty(true, 'Configuration required.');
          return;
        } else {
          showError(`${data.error}${data.details ? ': ' + data.details : ''}`);
          setEmpty(true, 'No results.');
          return;
        }
      }

      const arr = data.results || [];
      results.innerHTML = '';
      if (arr.length === 0) { setEmpty(true, 'No veteran-focused places found for that area.'); return; }
      setEmpty(false);
      arr.forEach(p => results.appendChild(makeCard(p)));
    } catch (e) {
      showError('Search failed. Check server logs.');
      setEmpty(true, 'Search failed.');
      console.error(e);
    }
  }

  // Added by Web Developer GPT (2025-10-08): robust geolocation with HTTPS check + permission hints
  function geolocate() {
    hideError();
    setGeo('');

    if (!('geolocation' in navigator)) {
      showError('Geolocation not supported by this browser.');
      return;
    }

    try {
      if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({ name: 'geolocation' }).then(status => {
          if (status.state === 'denied') {
            setGeo('Location permission is blocked. Enable it in your browser site settings.');
          } else if (status.state === 'prompt') {
            setGeo('Your browser will ask for permission to use your location.');
          } else if (status.state === 'granted') {
            setGeo('Using your current location…');
          }
        }).catch(() => {});
      }
    } catch (_) {}

    const opts = { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 };
    navigator.geolocation.getCurrentPosition(
      pos => {
        latI.value = pos.coords.latitude.toFixed(6);
        lngI.value = pos.coords.longitude.toFixed(6);
        setGeo(`Location set. (${latI.value}, ${lngI.value})`);
      },
      errObj => {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          showError('Geolocation requires HTTPS (or localhost). Serve the site over HTTPS.');
        } else {
          showError(errObj.message || 'Failed to get location.');
        }
        console.warn('Geolocation error:', errObj);
      },
      opts
    );
  }

  // Events
  btnLocate.addEventListener('click', geolocate);
  btnSearch.addEventListener('click', runSearch);

  // Added by Web Developer GPT (2025-10-08): if user types a place, prefer it over stale lat/lng
  place.addEventListener('input', () => { latI.value = ''; lngI.value = ''; });

})();
</script>
{% endblock %}
